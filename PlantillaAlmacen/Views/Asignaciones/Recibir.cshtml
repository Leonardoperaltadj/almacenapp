@model Paginacion<PlantillaAlmacen.Models.Asignacion>
@{
    ViewData["Title"] = "Recepciones";
    Layout = "_Layout";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Recepción de artículos</h1>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-outline card-secondary">
            <div class="card-body">
                <form asp-action="Recibir" method="get" class="form-inline mb-3">
                    <div class="input-group w-50">
                        <input type="text" name="buscador" value="@ViewData["Buscador"]"
                               class="form-control" placeholder="Buscar por producto, marca, modelo, serie o destino...">
                        <span class="input-group-append">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            <a asp-action="Recibir" class="btn btn-outline-secondary">
                                <i class="fas fa-list"></i> Ver todo
                            </a>
                        </span>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover text-nowrap">
                        <thead class="bg-dark">
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>
                                    <a asp-action="Recibir"
                                       asp-route-ordenacion="@ViewData["OrdenacionFecha"]"
                                       asp-route-buscador="@ViewData["Buscador"]"
                                       asp-route-tamanoPagina="@ViewData["TamanoPagina"]"
                                       class="text-white">
                                        Fecha asignación <i class="fas fa-sort"></i>
                                    </a>
                                </th>
                                <th>No. Serie</th>
                                <th>Asignado a</th>
                                <th>Estado entrega</th>
                                <th style="width:120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var destino = item.Personal?.Nombre ?? item.Departamento?.Nombre ?? item.Frente?.Nombre ?? "—";
                                <tr>
                                    <td>@item.Articulo?.CatalogoArticulo?.Nombre</td>
                                    <td>@item.Articulo?.CatalogoArticulo?.Categoria?.Nombre</td>
                                    <td>@item.FechaAsignacion.ToString("dd/MM/yyyy")</td>
                                    <td>@item.Articulo?.NumeroInventario</td>
                                    <td>@destino</td>
                                    <td>@item.EstadoEntrega?.Nombre</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success" onclick="abrirRecibirModal(@item.IdAsignacion)">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-footer d-flex justify-content-between align-items-center">
                    @{
                        var previoDeshabilitado = !Model.TienePaginaAnterior ? "disabled" : "";
                        var siguienteDeshabilitado = !Model.TienePaginaSiguiente ? "disabled" : "";
                    }

                    <div class="btn-group" role="group">
                        <a asp-action="Recibir"
                           asp-route-ordenacion="@ViewData["Ordenacion"]"
                           asp-route-numeroPagina="@(Model.IndicePagina - 1)"
                           asp-route-buscador="@ViewData["Buscador"]"
                           asp-route-tamanoPagina="@ViewData["TamanoPagina"]"
                           class="btn btn-secondary @previoDeshabilitado">
                            <i class="fas fa-chevron-left"></i> Previo
                        </a>

                        <a asp-action="Recibir"
                           asp-route-ordenacion="@ViewData["Ordenacion"]"
                           asp-route-numeroPagina="@(Model.IndicePagina + 1)"
                           asp-route-buscador="@ViewData["Buscador"]"
                           asp-route-tamanoPagina="@ViewData["TamanoPagina"]"
                           class="btn btn-secondary @siguienteDeshabilitado">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>

                    <div class="text-muted">
                        Página <strong>@Model.IndicePagina</strong> de <strong>@Model.TotalPaginas</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="recibirModal" tabindex="-1" role="dialog" aria-labelledby="recibirLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="recibirLabel">Registrar devolución</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formRecibir" method="post" asp-action="Recibir">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="rec_IdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <dl class="row">
                            <dt class="col-sm-3">Producto</dt>
                            <dd class="col-sm-9" id="recProd"></dd>

                            <dt class="col-sm-3">Categoría</dt>
                            <dd class="col-sm-9" id="recCat"></dd>

                            <dt class="col-sm-3">Asignado a</dt>
                            <dd class="col-sm-9"><span id="recDestino"></span> <small class="text-muted" id="recDestinoTipo"></small></dd>

                            <dt class="col-sm-3">Estado entrega</dt>
                            <dd class="col-sm-9" id="recEstEnt"></dd>

                            <dt class="col-sm-3">Fecha asignación</dt>
                            <dd class="col-sm-9" id="recFechaAsig"></dd>
                        </dl>
                    </div>

                    <div class="form-group">
                        <label for="IdEstadoRecepcion">Estado al recibir</label>
                        <select id="IdEstadoRecepcion" name="IdEstadoRecepcion" asp-items="ViewBag.EstadosRecepcion" class="form-control">
                            <option value="">-- Seleccione estado --</option>
                        </select>
                    </div>

                    <div class="form-group mt-3 d-none" id="wrapObservaciones">
                        <label for="Observaciones">Observaciones</label>
                        <textarea id="Observaciones" name="Observaciones" class="form-control"
                                  placeholder="Notas de la revisión / daños / accesorios, etc."></textarea>
                    </div>

                    <div class="form-group mt-3 d-none" id="wrapEvidencias">
                        <label for="Evidencias">Evidencias (fotos, PDF, etc.)</label>
                        <input type="file" id="Evidencias" name="Evidencias" multiple class="form-control" />
                    </div>


                    <div class="form-group mt-3 text-end">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar devolución
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function abrirRecibirModal(id) {
            $.ajax({
                url: '/Asignaciones/DetallesJson/' + id,
                type: 'GET',
                success: function (data) {
                    $('#rec_IdAsignacion').val(data.idAsignacion);
                    $('#recProd').text(data.articulo || '');
                    $('#recCat').text(data.categoria || '');
                    $('#recDestino').text(data.destinoNombre || '');
                    $('#recDestinoTipo').text(data.destinoTipo ? '(' + data.destinoTipo + ')' : '');
                    $('#recEstEnt').text(data.estadoEntrega || '');
                    $('#recFechaAsig').text(data.fechaAsignacion || '');
                    $('#IdEstadoRecepcion').val('');
                    $('#Observaciones').val('');
                    $('#recibirModal').modal('show');
                },
                error: function () {
                    alert("No se pudieron cargar los datos de la asignación.");
                }
            });
        }

        $('#formRecibir').on('submit', function (e) {
            e.preventDefault();

            var estadoRec = $('#IdEstadoRecepcion').val();
            if (!estadoRec) {
                alert("Seleccione el estado al recibir.");
                return;
            }
            var formData = new FormData(this);
            $.ajax({
                url: '/Asignaciones/Recibir',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhrFields: { responseType: 'blob' },
                success: function (data, status, xhr) {
                    var disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        var fileName = disposition.split('filename=')[1].trim();
                        var blob = new Blob([data], { type: 'application/pdf' });
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = fileName.replace(/"/g, '');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    $('#recibirModal').modal('hide');
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseText || "No se pudo registrar la devolución.");
                }
            });
        });

        $('#IdEstadoRecepcion').on('change', function () {
            var val = parseInt($(this).val());
            if (val && val != 4) {
                $('#wrapObservaciones').removeClass('d-none');
                $('#wrapEvidencias').removeClass('d-none');
            } else {
                $('#wrapObservaciones').addClass('d-none');
                $('#wrapEvidencias').addClass('d-none');
                $('#Observaciones').val('');
                $('#Evidencias').val('');
            }
        });


    </script>
}
